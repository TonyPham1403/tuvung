<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·∫Øc nghi·ªám H√°n t·ª±</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: center;
            align-items: center;
            background-color: #f5f5f5;
        }

        .question {
            font-size: 28px;
            margin: 0;
            /* Kh√¥ng c√≥ kho·∫£ng c√°ch tr√™n d∆∞·ªõi */
            font-weight: bold;
        }

        h2 {
            margin: 0 !important;
            padding: 0 !important;
            line-height: 1;
        }


        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            width: 90vw;
            max-width: 600px;
            height: 50vh;
            max-height: 300px;
        }

        .option {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #ffffff;
            border: 2px solid #ccc;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            border-radius: 10px;
            transition: 0.3s ease;
            width: 100%;
            height: 100%;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }

        .option:hover {
            background: #d9d9d9;
            transform: scale(1.05);
        }

        .option.correct {
            background: #28a745 !important;
            color: white;
            border-color: #1e7e34;
        }

        .option.wrong {
            background: #dc3545 !important;
            color: white;
            border-color: #a71d2a;
        }


        .navBtn {
            padding: 12px 25px;
            font-size: 20px;
            cursor: pointer;
            margin: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            transition: 0.3s ease;
        }

        .navBtn:hover {
            background: #0056b3;
        }

        .navBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .fixed-bottom {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            /* Ho·∫∑c ƒë·∫∑t gi√° tr·ªã c·ªë ƒë·ªãnh nh∆∞ max-width: 600px */
            max-width: 600px;
            /* Gi·ªØ c·ªë ƒë·ªãnh chi·ªÅu r·ªông */
            background: white;
            padding: 10px 20px;
            text-align: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #explanation {
            font-size: 20px;
            font-style: italic;
            color: #555;
            min-height: 50px;
            /* Gi·ªØ c·ªë ƒë·ªãnh chi·ªÅu cao t·ªëi thi·ªÉu */
            max-width: 100%;
            /* Kh√¥ng v∆∞·ª£t qu√° gi·ªõi h·∫°n */
            word-wrap: break-word;
            /* T·ª± ƒë·ªông xu·ªëng d√≤ng khi v∆∞·ª£t qu√° chi·ªÅu r·ªông */
            text-align: center;
            padding: 5px;
        }


        .history-menu {
            position: fixed;
            top: 70px;
            /* ƒêi·ªÅu ch·ªânh kho·∫£ng c√°ch so v·ªõi ƒëi·ªÉm s·ªë */
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            display: none;
            max-height: 200px;
            width: 350px;
            /* ƒê·ªô r·ªông ph√π h·ª£p */
            overflow-y: auto;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }


        .history-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* 2 c·ªôt */
            gap: 5px;
            /* Kho·∫£ng c√°ch gi·ªØa c√°c √¥ */
        }

        .history-item {
            background: #f8f8f8;
            padding: 8px;
            border-radius: 3px;
            text-align: center;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .history-item:hover {
            background: #e0e0e0;
        }



        #menuButton {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 24px;
            background: white;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* /////////////// */
        .back-container {
            position: fixed;
            top: 10px;
            right: 70px;
            z-index: 1001;
            /* ƒê·∫£m b·∫£o kh√¥ng b·ªã che */
        }

        /* N√∫t "Quay v·ªÅ m·ªõi nh·∫•t" */
        #backToLatestBtn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 21px;
            cursor: pointer;
            border-radius: 5px;
            white-space: nowrap;
            /* Tr√°nh xu·ªëng d√≤ng */
        }

        #backToLatestBtn:hover {
            background-color: #2980b9;
        }



        /* N√∫t "Home" */
        #homeButton {
            position: fixed;
            /* Gi·ªØ c·ªë ƒë·ªãnh tr√™n m√†n h√¨nh */
            top: 10px;
            /* Kho·∫£ng c√°ch t·ª´ tr√™n xu·ªëng */
            left: 120px;
            /* Kho·∫£ng c√°ch t·ª´ ph·∫£i sang (b·∫°n c√≥ th·ªÉ t·ª± ch·ªânh) */
            background-color: #2ecc71;
            /* Xanh l√° */
            color: white;
            border: none;
            padding: 10px 15px;
            /* ƒêi·ªÅu ch·ªânh padding */
            font-size: 18px;
            /* K√≠ch th∆∞·ªõc ch·ªØ h·ª£p l√Ω */
            cursor: pointer;
            border-radius: 5px;
            white-space: nowrap;
        }


        #homeButton:hover {
            background-color: #27ae60;
        }
    </style>
</head>

<body>
    <!-- N√∫t "Home" (·ªü gi·ªØa) -->
    <div class="home-container">
        <button id="homeButton">üè† Home</button>
    </div>
    <div class="back-container">
        <button id="backToLatestBtn">‚èÆ</button>
    </div>
    <div style="position: fixed; top: 10px; right: 10px;">

        <button id="menuButton">‚ò∞</button>
        <div class="history-menu" id="historyMenu"></div>
    </div>

    <div class="fixed-bottom">
        <div id="quizContainer" class="quiz-container">
            <div class="question" id="question"></div>

            <div class="options-container" id="answers"></div>

            <div id="explanation"></div>

            <button class="navBtn" id="prevBtn" disabled>&lt; Tr∆∞·ªõc</button>
            <button class="navBtn" id="nextBtn" disabled>Ti·∫øp &gt;</button>
        </div>
    </div>

    <script>
        let data = [];
        let currentQuestion = 0;
        let latestQuestion = 0;
        let history = [];
        let score = 0; // Bi·∫øn l∆∞u ƒëi·ªÉm

        // L·∫•y danh s√°ch b·ªô th·ªß t·ª´ URL
        let boThuList = new URLSearchParams(window.location.search).get("boThu");
        if (boThuList) {
            boThuList = boThuList.split(",");
        } else {
            document.getElementById("question").innerHTML = "Kh√¥ng c√≥ b·ªô th·ªß n√†o ƒë∆∞·ª£c ch·ªçn!";
            throw new Error("Kh√¥ng c√≥ b·ªô th·ªß n√†o ƒë∆∞·ª£c ch·ªçn!");
        }

        // Fetch d·ªØ li·ªáu t·ª´ data.json
        fetch("data.json")
            .then(response => response.json())
            .then(json => {
                boThuList.forEach(boThu => {
                    if (json[boThu]) {
                        data = data.concat(json[boThu]);
                    }
                });

                if (data.length < 4) {
                    document.getElementById("question").innerHTML = "Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ t·∫°o c√¢u h·ªèi!";
                    return;
                }

                shuffleArray(data); // Tr·ªôn c√¢u h·ªèi
                loadQuestion(); // Hi·ªÉn th·ªã c√¢u h·ªèi ƒë·∫ßu ti√™n
                updateScoreDisplay(); // C·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë ban ƒë·∫ßu
            })
            .catch(error => {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
                document.getElementById("question").innerHTML = "L·ªói khi t·∫£i d·ªØ li·ªáu!";
            });

        // X·ª≠ l√Ω n√∫t Previous
        document.getElementById("prevBtn").addEventListener("click", () => {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadQuestion(); // ƒê·ªïi sang c√¢u h·ªèi tr∆∞·ªõc ƒë√≥
            }
        });

        // X·ª≠ l√Ω n√∫t Next
        document.getElementById("nextBtn").addEventListener("click", () => {
            if (currentQuestion < latestQuestion) {
                currentQuestion++;
                loadQuestion(); // ƒê·ªïi sang c√¢u h·ªèi ti·∫øp theo
            }
        });


        // M·ªü menu l·ªãch s·ª≠
        document.getElementById("menuButton").addEventListener("click", function () {
            let menu = document.getElementById("historyMenu");

            if (menu.style.display === "block") {
                menu.style.display = "none";
            } else {
                menu.style.display = "block";
                menu.style.left = "50%"; // Gi·ªØ cƒÉn gi·ªØa
                menu.style.top = "70px"; // Gi·ªØ ƒë√∫ng v·ªã tr√≠ d∆∞·ªõi score
                menu.style.transform = "translateX(-50%)"; // ƒê·∫£m b·∫£o cƒÉn gi·ªØa theo tr·ª•c ngang
            }
        });



        // H√†m tr·ªôn m·∫£ng
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function loadQuestion() {
            // X√≥a l·ªùi gi·∫£i th√≠ch khi chuy·ªÉn sang c√¢u m·ªõi
            document.getElementById("explanation").textContent = "";

            if (data.length === 0) {
                document.getElementById("question").innerHTML = "‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu!";
                return;
            }

            let item;
            let allAnswers;
            let isReviewing = currentQuestion < latestQuestion; // N·∫øu currentQuestion < latestQuestion => ƒêang xem l·∫°i l·ªãch s·ª≠

            if (history[currentQuestion]) {
                // N·∫øu c√¢u h·ªèi ƒë√£ c√≥ trong l·ªãch s·ª≠, l·∫•y l·∫°i c√¢u c≈©
                item = history[currentQuestion].question;
                allAnswers = history[currentQuestion].answers;
            } else {
                // Ch·ªçn ng·∫´u nhi√™n m·ªôt c√¢u h·ªèi m·ªõi
                let randomIndex = Math.floor(Math.random() * data.length);
                item = data[randomIndex];

                let correctAnswer = item["√ù nghƒ©a"];

                // L·∫•y ng·∫´u nhi√™n 3 ƒë√°p √°n sai t·ª´ data (kh√¥ng bao g·ªìm c√¢u h·ªèi hi·ªán t·∫°i)
                let wrongAnswers = [];
                while (wrongAnswers.length < 3) {
                    let randomWrongIndex = Math.floor(Math.random() * data.length);
                    let randomWrongAnswer = data[randomWrongIndex]["√ù nghƒ©a"];
                    if (randomWrongAnswer !== correctAnswer && !wrongAnswers.includes(randomWrongAnswer)) {
                        wrongAnswers.push(randomWrongAnswer);
                    }
                }

                allAnswers = [correctAnswer, ...wrongAnswers];
                shuffleArray(allAnswers); // Tr·ªôn c√°c ƒë√°p √°n

                // L∆∞u c√¢u h·ªèi v√†o l·ªãch s·ª≠
                history[currentQuestion] = {
                    question: item,
                    answers: allAnswers,
                    selected: null,
                    correct: true,
                    firstAttempt: false,
                    explanation: item["V√≠ d·ª•"] || "Kh√¥ng c√≥ gi·∫£i th√≠ch."
                };
            }

            // Hi·ªÉn th·ªã c√¢u h·ªèi v√† ƒë√°p √°n
            document.getElementById("question").innerHTML = `<h2>${item["Ch·ªØ H√°n"]} (${item["ƒê·ªô ph·ªï bi·∫øn"]})</h2>`;

            let answers = document.getElementById("answers");
            answers.innerHTML = "";

            allAnswers.forEach(ans => {
                let div = document.createElement("div");
                div.classList.add("option");
                div.textContent = ans;

                // üõ† N·∫øu ƒëang xem l·∫°i l·ªãch s·ª≠ (currentQuestion < latestQuestion), kh√≥a click
                if (!isReviewing) {
                    div.onclick = () => handleAnswerClick(div, ans, item["√ù nghƒ©a"], item["V√≠ d·ª•"]);
                } else {
                    div.style.pointerEvents = "none"; // Kh√≥a click
                    // div.style.opacity = "0.6"; // L√†m m·ªù ƒë·ªÉ hi·ªÉn th·ªã ƒë√¢y l√† l·ªãch s·ª≠
                }

                // ƒê√°nh d·∫•u ƒë√°p √°n ƒë√£ ch·ªçn tr∆∞·ªõc ƒë√≥
                if (history[currentQuestion].selected === ans) {
                    div.classList.add(history[currentQuestion].correct ? "correct" : "wrong");
                }

                answers.appendChild(div);
            });

            // üõ† Ch·ªâ hi·ªÉn th·ªã l·ªùi gi·∫£i th√≠ch n·∫øu ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ho·∫∑c khi xem l·∫°i l·ªãch s·ª≠
            if (history[currentQuestion].selected && history[currentQuestion].correct) {
                document.getElementById("explanation").textContent = history[currentQuestion].explanation;
            }

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
            document.getElementById("prevBtn").disabled = currentQuestion === 0;
            document.getElementById("nextBtn").disabled = currentQuestion >= latestQuestion;

            updateHistoryMenu();
        }




        // X·ª≠ l√Ω khi ch·ªçn ƒë√°p √°n
        function handleAnswerClick(div, selectedAnswer, correctAnswer, example) {
            let questionData = history[currentQuestion]; // L·∫•y d·ªØ li·ªáu c√¢u h·ªèi t·ª´ history

            if (!questionData.selected) {
                questionData.selected = selectedAnswer;
                questionData.correct = selectedAnswer === correctAnswer;
                questionData.firstAttempt = true;

                // ‚úÖ Ch·ªâ c·ªông ƒëi·ªÉm n·∫øu ch·ªçn ƒë√∫ng ngay l·∫ßn ƒë·∫ßu
                if (questionData.correct) {
                    score++;
                }
            } else {
                questionData.correct = selectedAnswer === correctAnswer;
                questionData.selected = selectedAnswer;
            }

            let answerOptions = document.querySelectorAll(".option");
            if (selectedAnswer === correctAnswer) {
                div.classList.add("correct");
                document.getElementById("explanation").textContent = `${example}`;
                document.getElementById("nextBtn").disabled = false;

                if (currentQuestion === latestQuestion) {
                    latestQuestion++;
                }


                answerOptions.forEach(option => {
                    option.onclick = null;
                    option.style.pointerEvents = "none";
                });

                setTimeout(() => {
                    currentQuestion++;
                    loadQuestion(); // Chuy·ªÉn sang c√¢u h·ªèi ti·∫øp theo
                    updateScoreDisplay();
                }, 600);
            } else {
                div.classList.add("wrong");
                // document.getElementById("explanation").textContent = `‚ùå Sai! ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}`;
                document.getElementById("explanation").textContent = "";

            }

            updateHistoryMenu();
        }



        // C·∫≠p nh·∫≠t menu l·ªãch s·ª≠
        // C·∫≠p nh·∫≠t menu l·ªãch s·ª≠
        // C·∫≠p nh·∫≠t menu l·ªãch s·ª≠
        function updateHistoryMenu() {
            let menu = document.getElementById("historyMenu");
            menu.innerHTML = ""; // X√≥a n·ªôi dung c≈©

            let grid = document.createElement("div");
            grid.className = "history-grid";

            history.forEach((entry, index) => {
                let item = document.createElement("div");
                item.className = "history-item";

                // ‚úÖ Hi·ªÉn th·ªã d·∫°ng "Ch·ªØ H√°n - √ù nghƒ©a"
                let chuHan = entry.question["Ch·ªØ H√°n"] || "N/A";
                let yNghia = entry.question["√ù nghƒ©a"] || "Kh√¥ng r√µ";
                item.innerText = `${chuHan} - ${yNghia}`;

                // ‚úÖ Ch·ªâ ƒë√°nh d·∫•u ƒë·ªè n·∫øu l·∫ßn ƒë·∫ßu ch·ªçn sai
                if (!entry.correct && entry.firstAttempt) {
                    entry.markWrongFirstAttempt = true;
                }

                // ‚úÖ X√°c ƒë·ªãnh m√†u d·ª±a tr√™n k·∫øt qu·∫£ l·∫ßn ƒë·∫ßu
                if (entry.markWrongFirstAttempt) {
                    item.style.background = "#FF0000"; // ƒê·ªè n·∫øu sai ngay l·∫ßn ƒë·∫ßu
                    item.style.color = "white";
                } else if (entry.correct) {
                    item.style.background = "#4CAF50"; // Xanh l√° n·∫øu ch·ªçn ƒë√∫ng ngay l·∫ßn ƒë·∫ßu
                    item.style.color = "white";
                } else {
                    item.style.background = "#FFFFFF"; // Tr·∫Øng n·∫øu ch∆∞a ch·ªçn
                    item.style.color = "black";
                }

                // ‚úÖ Khi b·∫•m v√†o l·ªãch s·ª≠ th√¨ hi·ªÉn th·ªã l·∫°i c√¢u h·ªèi
                item.onclick = () => {
                    currentQuestion = index;
                    loadQuestion(index);
                };

                grid.appendChild(item);
            });

            menu.appendChild(grid);
        }









        function updateScoreDisplay() {
            let scoreElement = document.getElementById("scoreDisplay");

            if (!scoreElement) {
                scoreElement = document.createElement("div");
                scoreElement.id = "scoreDisplay";
                scoreElement.style.position = "absolute";
                scoreElement.style.top = "10px";
                scoreElement.style.left = "50%";
                scoreElement.style.transform = "translateX(-50%)";
                scoreElement.style.background = "#fff";
                scoreElement.style.padding = "10px";
                scoreElement.style.border = "1px solid #000";
                scoreElement.style.fontSize = "20px";
                document.body.appendChild(scoreElement);
            }

            let totalAnswered = history.filter(q => q.firstAttempt !== undefined).length;
            let percentage = totalAnswered > 0 ? ((score / totalAnswered) * 100).toFixed(2) : 0;

            scoreElement.innerText = `ƒêi·ªÉm: ${score}/${totalAnswered} (${percentage}%)`;
        }



        document.getElementById("backToLatestBtn").onclick = function () {
            currentQuestion = latestQuestion; // C·∫≠p nh·∫≠t v·ªÅ c√¢u m·ªõi nh·∫•t
            loadQuestion(); // Hi·ªÉn th·ªã l·∫°i c√¢u h·ªèi
        };
        document.getElementById("homeButton").addEventListener("click", function () {
            window.location.href = "index.html";
        });

    </script>
</body>


</html>